<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schultz's Weekly Lesson Plan Displayer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* A light gray background */
        }
        /* Simple scrollbar styling */
        .lesson-container::-webkit-scrollbar {
            width: 8px;
        }
        .lesson-container::-webkit-scrollbar-track {

            background: #512888;

            border-radius: 10px;
        }
        .lesson-container::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        .lesson-container::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .filter-container select, .filter-container input {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Schultz's Weekly Lesson Plan</h1>
            <p class="text-md text-gray-500 mt-2">A dynamic display of the weekly schedule for Mr. Schultz's Class</p>
        
            <!-- Filters for Date and Class -->
            <div class="mt-6 p-4 bg-white rounded-lg shadow-md max-w-2xl mx-auto filter-container">
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                    <div>
                        <label for="date-picker" class="block text-sm font-medium text-gray-700 mb-1">Select a Date</label>
                        <input type="date" id="date-picker" class="w-full sm:w-auto p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="class-selector" class="block text-sm font-medium text-gray-700 mb-1">Select a Class</label>
                        <select id="class-selector" class="w-full sm:w-auto p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option>Loading classes...</option>
                        </select>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main container for the lesson plan grid -->
        <div id="lesson-plan-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
            <!-- Loading Skeletons will be shown initially -->
            <div id="loading-state" class="col-span-1 md:col-span-2 lg:col-span-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                <script>
                    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                    days.forEach(day => {
                        document.write(`
                            <div class="bg-white p-4 rounded-lg shadow animate-pulse">
                                <div class="h-6 bg-gray-300 rounded w-3/4 mb-4"></div>
                                <div class="space-y-4">
                                    <div class="h-20 bg-gray-200 rounded"></div>
                                    <div class="h-20 bg-gray-200 rounded"></div>
                                </div>
                            </div>
                        `);
                    });
                </script>
            </div>
             <!-- Info message container for when no lessons are found -->
            <div id="info-message" class="hidden col-span-1 md:col-span-2 lg:col-span-5 text-center bg-blue-100 text-blue-700 p-4 rounded-lg shadow"></div>
            <!-- Error message container -->
            <div id="error-message" class="hidden col-span-1 md:col-span-2 lg:col-span-5 text-center bg-red-100 text-red-700 p-4 rounded-lg shadow"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTgYI7cYRtsyUuJej3Nqy1K18KpYHn1o_YwTnnN4wxaRfhou1BEcrDniPGv0zdG2pZv3sT_Q7Dxc1G6/pub?gid=2086096662&single=true&output=csv';
            
            // UI Elements
            const datePicker = document.getElementById('date-picker');
            const classSelector = document.getElementById('class-selector');
            const container = document.getElementById('lesson-plan-container');
            const loadingState = document.getElementById('loading-state');
            const errorMessage = document.getElementById('error-message');
            const infoMessage = document.getElementById('info-message');

            let allLessons = []; // To store all fetched lessons

            /**
             * Fetches and initializes the lesson plan data and filters.
             */
            async function initializeLessonPlan() {
                try {
                    const response = await fetch(sheetUrl);
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                    
                    const csvText = await response.text();
                    allLessons = parseCSV(csvText);

                    // --- DIAGNOSTIC LOGS ---
                    console.log("--- Data Loading Report ---");
                    console.log(`Successfully fetched and parsed the CSV. Found ${allLessons.length} total lesson rows.`);
                    if (allLessons.length > 0) {
                        console.log("Sample of first lesson data:", allLessons[0]);
                    }
                    console.log("--------------------------");


                    // Set the date picker to default to today's date.
                    datePicker.valueAsDate = new Date();

                    populateClassFilter(allLessons);

                    // Trigger the initial display with the new, smarter date
                    handleFilterChange();

                    // Add event listeners for filters
                    datePicker.addEventListener('change', handleFilterChange);
                    classSelector.addEventListener('change', handleFilterChange);

                } catch (error) {
                    console.error('Failed to load or parse lesson plan:', error);
                    errorMessage.textContent = 'Failed to load lesson plan data. Please check the Google Sheet URL and ensure it is published correctly.';
                    errorMessage.classList.remove('hidden');
                } finally {
                    loadingState.classList.add('hidden');
                }
            }
            
            /**
             * Populates the class selector dropdown with unique class names.
             */
            function populateClassFilter(lessons) {
                const classColumnName = 'class separator';
                // Get existing class names from the sheet data
                const dynamicClassNames = lessons.map(lesson => lesson[classColumnName]).filter(Boolean);
                
                // Add the user-requested classes
                const additionalClasses = ['Game Design', 'CSP'];

                // Combine, get unique values, and sort alphabetically
                const classNames = [...new Set([...dynamicClassNames, ...additionalClasses])].sort();

                classSelector.innerHTML = ''; // Clear loading message
                if(classNames.length > 0) {
                    classNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        classSelector.appendChild(option);
                    });
                } else {
                    classSelector.innerHTML = '<option>No classes found</option>';
                }
            }

            /**
             * Handles changes in the date or class filters and re-renders the lesson plan.
             */
            function handleFilterChange() {
                const selectedClass = classSelector.value;

                // --- FIX: Correctly handle date from picker to avoid timezone issues ---
                const dateString = datePicker.value;
                if (!dateString) return; // Exit if no date is selected

                const [year, month, day] = dateString.split('-').map(Number);
                const selectedDate = new Date(year, month - 1, day);

                // --- FIX: Improved and non-mutating week calculation ---
                const dayOfWeek = selectedDate.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
                const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                
                const monday = new Date(selectedDate); // Create a clone
                monday.setDate(selectedDate.getDate() + diffToMonday);

                const weekDateStrings = [];
                for (let i = 0; i < 5; i++) {
                    const day = new Date(monday);
                    day.setDate(monday.getDate() + i);
                    // Format as M/D/YYYY to match Google Sheets format
                    weekDateStrings.push(`${day.getMonth() + 1}/${day.getDate()}/${day.getFullYear()}`);
                }

                const filteredLessons = allLessons.filter(lesson => {
                    return lesson['class separator'] === selectedClass && weekDateStrings.includes(lesson['class dates']);
                });

                // --- DIAGNOSTIC LOGS ---
                console.log("--- Filtering Report ---");
                console.log(`Filtering for class "${selectedClass}" for the week starting ${weekDateStrings[0]}.`);
                console.log(`Found ${filteredLessons.length} matching lessons to display.`);
                console.log("-----------------------");


                displayLessons(filteredLessons, weekDateStrings);
            }

            function parseCSV(text) {
                const lines = text.trim().split(/\r?\n/);
                if (lines.length < 2) return [];
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/^"|"$/g, ''));
                const dataRows = lines.slice(1);
                return dataRows.map(line => {
                    if (!line.trim()) return null;
                    const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    const lesson = {};
                    headers.forEach((header, index) => {
                        const value = values[index] ? values[index].trim().replace(/^"|"$/g, '') : '';
                        lesson[header] = value;
                    });
                    return lesson;
                }).filter(lesson => lesson && lesson['class dates']);
            }

            function displayLessons(lessons, weekDates) {
                container.innerHTML = ''; // Clear previous content
                infoMessage.classList.add('hidden'); // Hide info message by default

                if (lessons.length === 0) {
                    infoMessage.textContent = 'No lessons found for the selected week and class.';
                    infoMessage.classList.remove('hidden');
                    container.appendChild(infoMessage);
                }

                const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                const lessonsByDay = {};
                daysOfWeek.forEach(day => lessonsByDay[day] = []);

                // --- DIAGNOSTIC LOGS for lesson sorting ---
                console.log("--- Lesson Sorting Report ---");
                lessons.forEach(lesson => {
                    if (lesson.day) {
                        // FIX: Normalize the 'day' property to match the keys (e.g., "Monday")
                        // This handles potential casing issues like "monday" vs "Monday".
                        const capitalizedDay = lesson.day.charAt(0).toUpperCase() + lesson.day.slice(1).toLowerCase();
                        if (lessonsByDay[capitalizedDay]) {
                            lessonsByDay[capitalizedDay].push(lesson);
                        } else {
                            console.warn(`Lesson found with an invalid day: "${lesson.day}"`, lesson);
                        }
                    } else {
                         console.warn("Lesson found without a 'day' property:", lesson);
                    }
                });
                console.log("Lessons sorted into days:", lessonsByDay);
                console.log("----------------------------");
                
                const subjectColors = {
                    'Default': 'bg-gray-100 border-gray-300'
                };

                daysOfWeek.forEach((day, index) => {
                    const dayColumn = document.createElement('div');
                    dayColumn.className = 'flex flex-col gap-4';
                    const dayHeader = document.createElement('h2');
                    dayHeader.className = 'text-xl font-bold text-center text-gray-700 sticky top-0 bg-gray-50 py-2 rounded-t-lg z-10 shadow-sm';
                    
                    const dateObj = new Date(weekDates[index]);
                    const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    dayHeader.textContent = `${day} (${formattedDate})`;
                    
                    dayColumn.appendChild(dayHeader);
                    
                    const lessonContainer = document.createElement('div');
                    lessonContainer.className = 'bg-white p-4 rounded-b-lg shadow-md flex-grow lesson-container space-y-4 overflow-y-auto h-[60vh]';
                    
                    const dayLessons = lessonsByDay[day];
                    if (dayLessons.length > 0) {
                        dayLessons.forEach(lesson => {
                            const colorClass = subjectColors['Default'];
                            const lessonCard = document.createElement('div');
                            lessonCard.className = `p-4 rounded-lg border-l-4 transition-transform transform hover:scale-105 hover:shadow-lg ${colorClass}`;
                            
                            // --- DYNAMIC CONTENT GENERATION ---
                            let cardHTML = `
                                <h3 class="font-bold text-lg text-gray-800">${lesson['lesson title'] || 'No Title'}</h3>
                                <div class="mt-3 text-sm text-gray-700 space-y-1">
                            `;

                            // Headers handled specially or that shouldn't be displayed in the dynamic list.
                            const excludedHeaders = ['class dates', 'day', 'class separator', 'lesson title', 'mini lesson link', 'mini lesson link text'];
                            
                            // Iterate over all properties of the lesson object
                            for (const header in lesson) {
                                // Check if it's not an excluded header and has a value
                                if (!excludedHeaders.includes(header) && lesson[header]) {
                                    const displayHeader = header.charAt(0).toUpperCase() + header.slice(1);
                                    cardHTML += `<p><span class="font-semibold">${displayHeader}:</span> ${lesson[header]}</p>`;
                                }
                            }
                            
                            // Special handling for the mini lesson link
                            const linkUrl = lesson['mini lesson link'];
                            const linkText = lesson['mini lesson link text'] || linkUrl; // Use URL as text if text is missing
                            if (linkUrl) {
                                cardHTML += `<p><span class="font-semibold">Mini Lesson Link:</span> <a href="${linkUrl}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline">${linkText}</a></p>`;
                            }

                            cardHTML += '</div>';
                            lessonCard.innerHTML = cardHTML;
                            lessonContainer.appendChild(lessonCard);
                        });
                    } else {
                        lessonContainer.innerHTML = `
                            <div class="text-center text-gray-500 p-8 flex flex-col items-center justify-center h-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                No lessons scheduled.
                            </div>`;
                    }
                    dayColumn.appendChild(lessonContainer);
                    container.appendChild(dayColumn);
                });
            }

            initializeLessonPlan();
        });
    </script>
</body>
</html>


